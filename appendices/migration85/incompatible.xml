<?xml version="1.0" encoding="utf-8"?>
<!-- EN-Revision: ec01a42be50e84f192c0b19fc6e9cf40a0f7ac31 Maintainer: mowangjuanzi Status: ready -->
<!-- CREDITS: Luffy -->
<sect1 xml:id="migration85.incompatible" xmlns:xlink="http://www.w3.org/1999/xlink">
 <title>不向后兼容的变更</title>

 <sect2 xml:id="migration85.incompatible.core">
  <title>PHP 核心</title>

  <sect3 xml:id="migration85.incompatible.core.array-callable-alias">
   <title><literal>"array"</literal> 和 <literal>"callable"</literal> 别名</title>

   <simpara>
    在 <function>class_alias</function> 中，不再允许使用 <literal>"array"</literal> 和 <literal>"callable"</literal> 作为类的别名名称
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.loosely-comparing-object">
   <title>宽松比较不可比较的对象</title>

   <simpara>
    之前，对不可比较的对象（例如枚举、<classname>CurlHandle</classname> 和其他内部类）进行宽松布尔比较时存在不一致性。如果与布尔字面量
    <code>$object == true</code> 进行比较，则其行为与 <code>(bool)$object</code> 相同；如果与静态未知值 <code>$object == $true</code>
    进行比较，则始终返回 &false;。此行为现已统一，始终遵循 <code>(bool)$object</code> 的行为。
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.gc-collect-cycles">
   <title>gc_collect_cycles 的返回值</title>

   <simpara>
    <function>gc_collect_cycles</function> 的返回值不再包括通过循环间接收集的字符串和资源。
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.substitute-final-subclasses">
   <title>在 final 子类中替换 static 关键字</title>

   <simpara>
    现在允许在 final 子类中将 <type>static</type> 替换为 <type>self</type> 或具体类名。
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.tick-handlers">
   <title>tick 处理程序</title>

   <simpara>
    tick 处理程序现在会在所有关闭函数和析构方法执行完毕、输出处理程序清理完成后停用。
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.trait-binding">
   <title>Trait 绑定</title>

   <simpara>
    Trait 现在会在父类之前绑定。这是一个细微的行为变更，但更符合用户的预期。
    <!-- https://github.com/php/php-src/pull/15878 -->
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.errors-compilation-and-linking">
   <title>编译和类链接过程中的错误</title>

   <simpara>
    编译和类链接过程中产生的错误现在一律延迟处理，并在编译或类链接完成后统一处理。若在编译或类链接期间产生致命错误，将立即处理所有已延迟的错误，且不调用用户定义的错误处理程序。
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.exception-by-userdefined-handler">
   <title>用户定义的错误处理程序抛出的异常</title>

   <simpara>
    用户定义的错误处理程序在处理类链接错误时抛出的异常，不再升级为致命错误，也不会阻止链接过程。
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.attribute-during-compilation">
   <title>应用的注解在编译期间出错</title>

   <simpara>
    将 <code>#[\Attribute]</code> 应用于抽象类、枚举、接口或 Trait 时，会在编译期间触发错误。此前，该注解虽可添加，但在调用
    <methodname>ReflectionAttribute::newInstance</methodname> 时才会抛出错误。通过使用新的
    <code>#[\DelayedTargetValidation]</code> 注解，可将此错误从编译期延迟至运行时。
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.disable-ini-setting">
   <title>disable_classes INI 配置项</title>

   <simpara>
    已移除 <link linkend="ini.disable-classes">disable_classes</link> INI 配置项，因其会导致引擎的多项假设失效。
    <!-- RFC: https://wiki.php.net/rfc/deprecations_php_8_5#remove_disable_classes_ini_setting -->
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.destruct-non-array-values">
   <title>解构非数组值</title>

   <simpara>
    使用 <literal>[]</literal> 或 <function>list</function> 解构非数组值（&null; 除外）时，现在会发出警告。
    <!-- RFC: https://wiki.php.net/rfc/warnings-php-8-5#destructuring_non-array_values -->
   </simpara>

  </sect3>

  <sect3 xml:id="migration85.incompatible.core.warning-related-to-cast">
   <title>与类型转换相关的警告</title>

   <simpara>
    当浮点数（或看起来像浮点数的字符串）无法精确表示为整数时，将其转换为整型会发出警告。此行为适用于显式和隐式的整型转换。
    <!-- RFC: https://wiki.php.net/rfc/warnings-php-8-5#casting_out_of_range_floats_to_int -->
   </simpara>

   <simpara>
    将 NAN 转换为其他类型时，现在会发出警告。
    <!-- RFC: https://wiki.php.net/rfc/warnings-php-8-5#coercing_nan_to_other_types -->
   </simpara>

  </sect3>

 </sect2>

 <sect2 xml:id="migration85.incompatible.bzip2">
  <title>Bzip2</title>

  <simpara>
   当 <parameter>$block_size</parameter> 不在 1 到 9 之间时，<function>bzcompress</function>
   现在会抛出 <classname>ValueError</classname>。
  </simpara>

  <simpara>
   当 <parameter>$work_factor</parameter> 不在 0 到 250 之间时，<function>bzcompress</function>
   现在会抛出 <classname>ValueError</classname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.dom">
  <title>DOM</title>

  <simpara>
   现在克隆 <classname>DOMNamedNodeMap</classname>、<classname>DOMNodeList</classname>、<classname>Dom\NamedNodeMap</classname>、<classname>Dom\NodeList</classname>、<classname>Dom\HTMLCollection</classname>
   和 <classname>Dom\DtdNamedNodeMap</classname> 会失败。此前此类操作从未生成有效的对象，因此预计不会产生实际影响。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.fileinfo">
  <title>FileInfo</title>

  <simpara>
   当 <parameter>$filename</parameter> 包含 nul 字节时，<function>finfo_file</function> 和
   <methodname>finfo::file</methodname> 现在抛出 <exceptionname>ValueError</exceptionname>
   而非 <exceptionname>TypeError</exceptionname>，以使抛出的错误类型与语言其他部分保持一致。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.intl">
  <title>Intl</title>

  <simpara>
   该扩展现在要求最低 ICU 57.1。
  </simpara>

  <simpara>
   <methodname>IntlDateFormatter::setTimeZone</methodname>/<function>datefmt_set_timezone</function>
   在类未初始化或克隆失败时，现在会抛出 <exceptionname>IntlException</exceptionname>。
  </simpara>

  <simpara>
   所有 <classname>Locale</classname> 方法在 locale 参数包含 null 字节时，现在均抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

  <simpara>
   <constant>Collator::SORT_REGULAR</constant>在处理数字字符串时的行为现已与
   ext/standard 中的 <constant>SORT_REGULAR</constant> 保持一致。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.ldap">
  <title>LDAP</title>

  <simpara>
   <function>ldap_get_option</function> 和 <function>ldap_set_option</function>
   当传递无效选项时现在抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.mbstring">
  <title>MBString</title>

  <simpara>
   Unicode 数据表已更新至 Unicode 17.0
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.mysqli">
  <title>MySQLi</title>

  <simpara>
   对已构造的对象再次调用 mysqli 构造方法现已不可行，并会抛出 <exceptionname>Error</exceptionname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.odbc">
  <title>ODBC</title>

  <simpara>
   ODBC 现在假定至少支持 ODBC 3.5 的功能，已移除用于控制相关 ODBCVER 定义及构建系统 flag。
  </simpara>

  <simpara>
   ODBC 不再提供针对特定驱动（DB2 除外）的构建 flag，并移除了针对这些驱动的特殊处理。在非
   Windows 系统上，强烈建议使用 iODBC 或 unixODBC 等驱动管理程序。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.opcache">
  <title>Opcache</title>

  <simpara>
   Opcache 扩展现已始终内置于 PHP 二进制文件中，并始终加载。INI 配置项 <link
   linkend="ini.opcache.enable">opcache.enable</link> 和 <link
   linkend="ini.opcache.enable-cli">opcache.enable_cli</link> 仍会生效。
  </simpara>

  <simpara>
   已移除 <option role="configure">--enable-opcache</option>/<option role="configure">--disable-opcache</option>
   配置选项，构建过程不再生成 <filename>opcache.so</filename> 或 <filename>php_opcache.dll</filename> 文件。
  </simpara>

  <simpara>
   使用 <literal>zend_extension=opcache.so</literal> 或
   <literal>zend_extension=php_opcache.dll</literal> 的 INI 配置项会触发警告。

  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.pcntl">
  <title>PCNTL</title>

  <simpara>
   <function>pcntl_exec</function> 在 <parameter>$args</parameter> 参数的元素包含
   null 字节时会抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

  <simpara>
   <function>pcntl_exec</function> 在 <parameter>$env_vars</parameter>
   参数的元素或 key 包含 null 字节时会抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.pcre">
  <title>PCRE</title>

  <simpara>
   该扩展在编译时未启用半废弃的 PCRE2_EXTRA_ALLOW_LOOKAROUND_BSK 编译选项。
   <!-- https://github.com/PCRE2Project/pcre2/issues/736#issuecomment-2754024651 -->
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.pdo">
  <title>PDO</title>

  <simpara>
   与 <constant>PDO::FETCH_CLASS</constant> 结合使用的构造方法参数现在遵循标准的
   CUFA（<function>call_user_func_array</function>）语义。这意味着字符串 key
   将作为命名参数。此外，不再自动包装按值参数，传递给引用参数，而是会发出常规的 <constant>E_WARNING</constant>
   警告。若需将变量以引用方式传入构造方法参数，应使用通用的数组值引用赋值方式：<code>$ctor_args = [&amp;$valByRef]</code>。
  </simpara>

  <simpara>
   在调用 <methodname>PDO::fetch</methodname>、<methodname>PDO::fetchObject</methodname> 或 <methodname>PDO::fetchAll</methodname>
   期间尝试调用 <methodname>PDOStatement::setFetchMode</methodname>，例如通过将语句对象作为构造方法参数传入以实现对象映射等技巧，现在会抛出
   <exceptionname>Error</exceptionname>。
  </simpara>

  <simpara>
   常量 <constant>PDO::FETCH_GROUP</constant>、<constant>PDO::FETCH_UNIQUE</constant>、<constant>PDO::FETCH_CLASSTYPE</constant>、<constant>PDO::FETCH_PROPS_LATE</constant>
   和 <constant>PDO::FETCH_SERIALIZE</constant> 的值已发生变化。
  </simpara>

  <simpara>
   若 <constant>PDO::FETCH_PROPS_LATE</constant> 与非 <constant>PDO::FETCH_CLASS</constant>
   的获取模式一同使用，现在会抛出 <exceptionname>ValueError</exceptionname>，与其他获取 flag 的行为保持一致。
  </simpara>

  <simpara>
   若在 <methodname>PDO::fetchAll</methodname> 中将 <constant>PDO::FETCH_INTO</constant>
   用作获取模式，现在会抛出 <exceptionname>ValueError</exceptionname>，与
   <constant>PDO::FETCH_LAZY</constant> 的行为类似。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.pdo-firebird">
  <title>PDO_FIREBIRD</title>

  <simpara>
   当尝试为 Firebird 驱动返回的 <classname>PDOStatement</classname>
   设置过长的游标名称时，现在会抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.pdo-sqlite">
  <title>PDO_SQLITE</title>

  <simpara>
   SQLite 的 <methodname>PDO::quote</methodname> 在字符串包含 null 字节时，会根据错误模式抛出异常或发出警告。
  </simpara>

  <simpara>
   <methodname>PDO::sqliteCreateCollation</methodname> 在 callback 返回类型不正确时会抛出异常，使其行为更符合
   <methodname>Pdo\Sqlite::createCollation</methodname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.posix">
  <title>POSIX</title>

  <simpara>
   <function>posix_kill</function> 在 process_id 参数超出平台支持范围（有符号整数或长整型范围）时会抛出
   <exceptionname>ValueError</exceptionname>；<function>posix_setpgid</function> 在 process_id
   或 process_group_id 小于零或超出平台支持范围时也会抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

  <simpara>
   <function>posix_setrlimit</function> 在 hard_limit 或 soft_limit 参数小于 -1，或 soft_limit
   大于 hard_limit 时会抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.reflection">
  <title>Reflection</title>

  <simpara>
   <methodname>ReflectionAttribute::newInstance</methodname> 现在可能在内部注解应用到无效目标时抛出错误，前提是该错误通过
   #[\DelayedTargetValidation] 注解从编译时延迟到了运行时。
   <!-- RFC: https://wiki.php.net/rfc/delayedtargetvalidation_attribute -->
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.session">
  <title>Session</title>

  <simpara>
   向会话写入数据时，若 <varname>$_SESSION</varname> 中的 key 包含竖线字符（<literal>|</literal>），现在会发出警告，而非静默失败。
  </simpara>

  <simpara>
   <function>session_start</function> 对 options 参数的校验更为严格：若该数组不是关联数组，会抛出
   <exceptionname>ValueError</exceptionname>；若 read_and_close 的值类型与 int 不兼容，则抛出
   <exceptionname>TypeError</exceptionname>。
  </simpara>

  <simpara>
   将整数 <literal>0</literal> 作为 <parameter>locales</parameter> 参数传递给
   <function>setlocale</function> 不再受支持，现会抛出 <exceptionname>TypeError</exceptionname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.simplexml">
  <title>SimpleXML</title>

  <simpara>
   向 <methodname>SimpleXMLElement::xpath</methodname> 传入返回结果非节点集的 XPath 表达式时，现在会发出警告并返回
   &false;，而非静默失败并返回空数组。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.snmp">
  <title>SNMP</title>

  <simpara>
   <function>snmpget</function>、<function>snmpset</function>、<function>snmp2_get</function>、<function>snmp2_set</function>、<function>snmp3_get</function>、<function>snmp3_set</function>
   和 <methodname>SNMP::__construct</methodname> 在主机名过长或包含 null
   字节、端口号为负数或大于 65535、超时或重试次数小于 -1 或过大时，会抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.soap">
  <title>SOAP</title>

  <simpara>
   <methodname>SoapClient::__doRequest</methodname> 现在接受新的可选参数 <parameter>$uriParserClass</parameter>，该参数可接收
   string 或 &null;。传入 &null; 表示使用原有的基于 <function>parse_url</function> 的方法，而传入
   <classname>Uri\Rfc3986\Uri</classname> 或 <classname>Uri\WhatWg\Url</classname> 时则会使用新的后端解析器。
   <!-- RFC: https://wiki.php.net/rfc/url_parsing_api#plugability -->
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.sockets">
  <title>Sockets</title>

  <simpara>
   <function>socket_create_listen</function>、<function>socket_bind</function> 和 <function>socket_sendto</function>
   在端口号小于 0 或大于 65535，或提示数组中的任一项使用数字索引时，会抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

  <simpara>
   <function>socket_addrinfo_lookup</function> 在提示值无法转换为整数时会抛出
   <exceptionname>TypeError</exceptionname>，若这些值发生溢出，则可能抛出 <exceptionname>ValueError</exceptionname>。
  </simpara>

  <simpara>
   使用 <constant>MCAST_LEAVE_GROUP</constant>/<constant>MCAST_LEAVE_SOURCE_GROUP</constant> 选项调用
   <function>socket_set_option</function> 时，若传入的值不是有效的对象或数组，会抛出异常。
  </simpara>

  <simpara>
   在多播上下文中调用 <function>socket_set_option</function> 时，若创建的套接字不属于
   <constant>AF_INET</constant>/<constant>AF_INET6</constant> 协议族，会抛出
   <exceptionname>ValueError</exceptionname>。

  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.spl">
  <title>SPL</title>

  <simpara>
   <classname>ArrayObject</classname> 不再接受枚举，因为修改 <property>$name</property>
   或 <property>$value</property> 属性可能破坏引擎设想。
  </simpara>

  <simpara>
   <methodname>SplFileObject::fwrite</methodname> 的参数 <parameter>$length</parameter>
   现在允许为 null，默认值由 <literal>0</literal> 改为 &null;。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.standard">
  <title>标准</title>

  <simpara>
   此前，使用 printf 系列函数时，若格式化字符串中的格式符未指定精度，会错误地将精度重置，而非将其视为精度为 0。
  </simpara>

 </sect2>

 <sect2 xml:id="migration85.incompatible.tidy">
  <title>Tidy</title>

  <simpara>
   <methodname>tidy::__construct</methodname>、<methodname>tidy::parseFile</methodname> 和
   <methodname>tidy::parseString</methodname> 在配置中包含无效值或尝试设置只读内部条目时会抛出
   <exceptionname>ValueError</exceptionname>；若配置 key 不是 string，则抛出
   <exceptionname>TypeError</exceptionname>。
  </simpara>

 </sect2>

</sect1>
<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"~/.phpdoc/manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
